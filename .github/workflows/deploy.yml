name: Deploy to Pi

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: tubtub/go.mod

      - name: Build
        working-directory: tubtub
        run: |
          mkdir -p dist
          CGO_ENABLED=0 go build -o dist/tubtub ./cmd/server

      - name: Deploy + restart (local)
        env:
          PI_PATH: ${{ secrets.PI_PATH }}
        run: |
          install_path="${PI_PATH:-/opt/tubtub}"
          sudo mkdir -p "$install_path"
          sudo rsync -az --delete \
            "$GITHUB_WORKSPACE/tubtub/dist/" \
            "$GITHUB_WORKSPACE/tubtub/web/" \
            "$install_path/"
          sudo systemctl restart tubtub
